#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "Usage: ./bot-ssh <user> | ./bot-ssh -k"
  exit 2
fi

if [[ "$1" == "-k" ]]; then
  if [[ ! -f ".ssh-connect" ]]; then
    exit 1
  fi
  # shellcheck disable=SC1091
  source ".ssh-connect"
  hostport="${BOT_SSH_PORT:-127.0.0.1:4221}"
  host="${hostport%:*}"
  port="${hostport##*:}"
  echo "[${host}]:${port} ${BOT_SERVER_PUBKEY}"
  exit 0
fi

user="$1"
key="resources/ssh-default/${user}.key"
connect_file=".ssh-connect"

if [[ ! -f "$key" ]]; then
  echo "Missing key: $key"
  exit 1
fi

chmod 600 "$key" 2>/dev/null || true

if [[ ! -f "$connect_file" ]]; then
  echo "Missing $connect_file; start gopherbot first"
  exit 1
fi

# shellcheck disable=SC1090
source "$connect_file"

hostport="${BOT_SSH_PORT:-127.0.0.1:4221}"
host="${hostport%:*}"
port="${hostport##*:}"
bot_ssh_path="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/bot-ssh"

ssh \
  -i "$key" \
  -p "$port" \
  -o IdentitiesOnly=yes \
  -o UserKnownHostsFile=/dev/null \
  -o StrictHostKeyChecking=yes \
  -o "KnownHostsCommand=$bot_ssh_path -k" \
  "${user}@${host}"
