#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: ./bot-ssh <user> | ./bot-ssh -l <user> | ./bot-ssh -k"
}

local_key=false
print_known_hosts=false
script_dir="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"
bot_ssh_path="${script_dir}/bot-ssh"

while getopts ":kl" opt; do
  case "$opt" in
    k)
      print_known_hosts=true
      ;;
    l)
      local_key=true
      ;;
    \?)
      usage
      exit 2
      ;;
  esac
done
shift $((OPTIND - 1))

if [[ "$print_known_hosts" == "true" ]]; then
  if [[ $# -ne 0 ]]; then
    usage
    exit 2
  fi
  if [[ ! -f "./.ssh-connect" ]]; then
    exit 1
  fi
  # shellcheck disable=SC1091
  source "./.ssh-connect"
  hostport="${BOT_SSH_PORT:-127.0.0.1:4221}"
  host="${hostport%:*}"
  port="${hostport##*:}"
  echo "[${host}]:${port} ${BOT_SERVER_PUBKEY}"
  exit 0
fi

if [[ $# -ne 1 ]]; then
  usage
  exit 2
fi

user="$1"
connect_file="./.ssh-connect"

if [[ ! -f "$connect_file" ]]; then
  echo "Missing $connect_file; start gopherbot first"
  exit 1
fi

# shellcheck disable=SC1090
source "$connect_file"

hostport="${BOT_SSH_PORT:-127.0.0.1:4221}"
host="${hostport%:*}"
port="${hostport##*:}"

if [[ "$local_key" == "true" ]]; then
  ssh \
    -p "$port" \
    -o UserKnownHostsFile=/dev/null \
    -o StrictHostKeyChecking=yes \
    -o "KnownHostsCommand=$bot_ssh_path -k" \
    "${user}@${host}"
else
  key="${script_dir}/resources/ssh-default/${user}.key"
  if [[ ! -f "$key" ]]; then
    echo "Missing key: $key"
    exit 1
  fi

  chmod 600 "$key" 2>/dev/null || true

  ssh \
    -i "$key" \
    -p "$port" \
    -o IdentitiesOnly=yes \
    -o UserKnownHostsFile=/dev/null \
    -o StrictHostKeyChecking=yes \
    -o "KnownHostsCommand=$bot_ssh_path -k" \
    "${user}@${host}"
fi
